# Le decimos a Caddy que estamos manejando HTTP internamente.
# Railway se encargará del HTTPS para el dominio público.
{
	auto_https off
}

# Escuchamos en el puerto 80 para todas las peticiones entrantes.
# Caddy usará automáticamente las variables de entorno aquí.
:80 {
	# --- GoTrue (Autenticación) ---
	# Todas las peticiones a /gotrue/* se envían al servicio GoTrue via IPv4.
	handle /gotrue/* {
		reverse_proxy {$GOTRUE_BACKEND_HOST}:{$GOTRUE_BACKEND_PORT} {
			transport http {
				dial_network tcp4
			}
		}
	}

	# --- Minio (Almacenamiento S3) ---
	# Todas las peticiones a /minio-api/* se envían al servicio Minio via IPv4.
	handle /minio-api/* {
		reverse_proxy {$MINIO_API_HOST}:{$MINIO_API_PORT} {
			transport http {
				dial_network tcp4
			}
		}
	}

	# --- AppFlowy (WebSocket para colaboración en tiempo real) ---
	# Se envía al backend de AppFlowy via IPv4.
	handle /ws {
		reverse_proxy {$APPFLOWY_BACKEND_HOST}:{$APPFLOWY_BACKEND_PORT} {
			transport http {
				dial_network tcp4
			}
		}
	}

	# --- AppFlowy (Backend principal - por defecto) ---
	# Todas las demás peticiones se envían al backend principal de AppFlowy via IPv4.
	# Este debe ser el último manejador "handle".
	handle {
		reverse_proxy {$APPFLOWY_BACKEND_HOST}:{$APPFLOWY_BACKEND_PORT} {
			transport http {
				dial_network tcp4
			}
		}
	}

	# --- Cabeceras Globales (CORS) ---
	# Añadimos las cabeceras CORS a todas las respuestas para permitir
	# que el frontend se conecte desde un dominio diferente.
	header {
		Access-Control-Allow-Origin "{$CORS_ORIGIN}"
		Access-Control-Allow-Methods "GET, POST, PUT, PATCH, DELETE, OPTIONS"
		Access-Control-Allow-Headers "*"
	}
} 
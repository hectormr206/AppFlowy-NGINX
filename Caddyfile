# Le decimos a Caddy que estamos manejando HTTP internamente.
# Railway se encargará del HTTPS para el dominio público.
{
	auto_https off
}

# La variable PORT la define Railway (la hemos puesto en 80).
# Si no, Caddy escucharía en el 443 por defecto.
:{$PORT} {
	# --- Manejadores de Proxy (usando variables oficiales) ---
	handle_path /gotrue/* {
		reverse_proxy {$ENV_GOTRUE}:{$ENV_GOTRUE_PORT}
	}

	handle_path /minio-api/* {
		reverse_proxy {$ENV_MINIO}:{$ENV_MINIO_PORT}
	}

	handle_path /ws {
		reverse_proxy {$ENV_APPFLOWY_CLOUD}:{$ENV_APPFLOWY_CLOUD_PORT}
	}

	handle {
		reverse_proxy {$ENV_APPFLOWY_CLOUD}:{$ENV_APPFLOWY_CLOUD_PORT}
	}

	# --- Cabeceras Globales de CORS (Completas y Robustas) ---
	# Caddy es ahora el ÚNICO responsable de esto.
	header {
		Access-Control-Allow-Origin "{$ENV_WEB_ORIGIN}"
		Access-Control-Allow-Methods "GET, POST, PUT, PATCH, DELETE, OPTIONS"
		Access-Control-Allow-Headers "*"
		Access-Control-Allow-Credentials "true"
		Access-Control-Expose-Headers "*"
	}
} 